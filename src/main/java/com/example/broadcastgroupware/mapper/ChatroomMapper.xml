<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.broadcastgroupware.mapper.ChatroomMapper">

	<!-- ===================================채팅방================================ -->
	<!--  목록 매핑 -->
	<resultMap id="ChatroomListMap" type="com.example.broadcastgroupware.dto.ChatroomListDto">
		<id		column="chatroom_id"		property="chatroomId"/>
		<result column="chatroom_name"		property="chatroomName"/>
		<result column="last_message"		property="lastMessage"/>
		<result column="last_message_at"	property="lastMessageAt"/>
		<result column="unread_count"		property="unreadCount"/>
		<result column="room_type"			property="roomType"/>
		<result column="dm_key"				property="dmKey"/>
		<result column="last_incoming_at"   property="lastIncomingAt"/> 
		
	<!-- 서비스에서 아바타이미지 계산용 원재료 -->
		<result column="peer_user_id"		property="peerUserId"/>
		<result column="peer_avatar_path"	property="peerAvatarPath"/>
		<result column="group_avatar_path"	property="groupAvatarPath"/>
		<result column="peer_user_rank"    property="peerUserRank"/>
	</resultMap>
	
	<!-- 내가 속한 DM 목록(상대 정보 포함) -->
	<select id="selectDmListByUser" parameterType="int" resultMap="ChatroomListMap">
	  SELECT
	      c.chatroom_id,
	      c.room_type,
	      c.dm_key,
	
	 	  lm.created_at AS last_message_at,	<!-- 합류 한 뒤 메시지 내용 -->
	 	  
	      <!-- 마지막 메시지 내용 -->
	      lm.content AS last_message,
	
	      /* (옵션) 안읽음 수: last_read_at이 있으면 유효, 없으면 0 */
	      COALESCE(unread.cnt, 0) AS unread_count,
	
	      /* 상대방 이름 */
	      u_peer.full_name AS chatroom_name,
	      
	      u_peer.user_rank        AS peer_user_rank,
	
	      <!-- 서비스용 원재료(선택): 상대 유저 ID -->
	      pid.peer_user_id AS peer_user_id,
	      
	      
	      li.last_incoming_at AS last_incoming_at
	  FROM chatroom c
	
	  /* 내가 속한 방 */
	  JOIN chatroom_user cu_self
	    ON cu_self.chatroom_id = c.chatroom_id
	   AND cu_self.user_id     = #{userId}
	   AND cu_self.chatroom_user_status = 'Y'		<!-- 상대방이 나가면 N이 되므로 Y만 보이게 -->
	
	  /* dm_key='min:max'에서 상대 user_id 계산 */
	  JOIN (
	    SELECT
	      c2.chatroom_id,
	      CASE
	        WHEN CAST(SUBSTRING_INDEX(c2.dm_key, ':', 1) AS UNSIGNED) = #{userId}
	          THEN CAST(SUBSTRING_INDEX(c2.dm_key, ':', -1) AS UNSIGNED)
	        ELSE CAST(SUBSTRING_INDEX(c2.dm_key, ':', 1)  AS UNSIGNED)
	      END AS peer_user_id
	    FROM chatroom c2
	  ) pid ON pid.chatroom_id = c.chatroom_id
	
	  /* 상대 유저 프로필 */
	  LEFT JOIN `user` u_peer
	    ON u_peer.user_id = pid.peer_user_id
	
	  /* 각 방의 최신 메시지 1건 */
	  LEFT JOIN (
		  SELECT m1.chatroom_id,
		         m1.chat_message_content AS content,
		         m1.create_date          AS created_at
		  FROM chat_message m1
		  JOIN (
		    SELECT m.chatroom_id, MAX(m.chat_message_id) AS max_id
		    FROM chat_message m
		    JOIN chatroom_user me
		      ON me.chatroom_id = m.chatroom_id
		     AND me.user_id     = #{userId}
		     AND me.chatroom_user_status = 'Y'
		    WHERE m.chat_message_status = 'Y'
		      AND m.create_date >= me.create_date   <!-- 내가 합류한 이후만 -->
		    GROUP BY m.chatroom_id
		  ) x ON x.chatroom_id = m1.chatroom_id
		     AND x.max_id      = m1.chat_message_id
		) lm ON lm.chatroom_id = c.chatroom_id
	
	  <!-- 안읽음 수 -->
	  LEFT JOIN (
		  SELECT me.chatroom_id, COUNT(*) AS cnt
		  FROM chat_message m
		  JOIN chatroom_user me
		    ON me.chatroom_id = m.chatroom_id
		   AND me.user_id     = #{userId}
		   AND me.chatroom_user_status = 'Y'
		  JOIN chatroom_user sender
		    ON sender.chatroom_user_id = m.chatroom_user_id
		  WHERE m.chat_message_status = 'Y'
		    AND m.create_date >= me.create_date      <!-- 합류 이후 -->
		    AND sender.user_id &lt;&gt; #{userId}        <!-- 남이 보낸 것만 -->
		    AND (me.last_read_at IS NULL OR m.create_date > me.last_read_at)
		  GROUP BY me.chatroom_id
		) unread ON unread.chatroom_id = c.chatroom_id
	  
	    <!-- ‘내가 받은’ 마지막 시간 계산 서브쿼리 -->
		LEFT JOIN (
		  SELECT m.chatroom_id,
		         MAX(m.create_date) AS last_incoming_at
		  FROM chat_message m
		  JOIN chatroom_user msg_cu
		    ON msg_cu.chatroom_user_id = m.chatroom_user_id
		  JOIN chatroom_user me
		    ON me.chatroom_id = m.chatroom_id
		   AND me.user_id     = #{userId}
		   AND me.chatroom_user_status = 'Y'
		  WHERE m.chat_message_status = 'Y'
		    AND msg_cu.user_id &lt;&gt; #{userId}  <!-- 남이 보낸 것만 -->
		    AND m.create_date >= me.create_date  <!-- 합류 이후만 -->
		  GROUP BY m.chatroom_id
		) li ON li.chatroom_id = c.chatroom_id
	  
	
	  WHERE c.room_type = 'DM'
	  ORDER BY
	   CASE WHEN li.last_incoming_at IS NULL THEN 1 ELSE 0 END ASC, <!--  받은 시간 없는 방은 뒤로 -->
	   li.last_incoming_at DESC,                          <!--  받은 메시지 최신순 -->
	   CASE WHEN li.last_incoming_at IS NULL THEN cu_self.create_date END DESC,	<!-- 받은 메시지가 아직 없을 경우 그 방에 합류한 시각으로 최신순 -->
	   c.chatroom_id ASC                                  <!--  안정적 보조키 (원하면 이름 ASC 등으로 교체) -->
	</select>
	
	  <!-- dm_key로 방 1개 조회 -->
  <select id="selectByDmKey" parameterType="string" resultType="com.example.broadcastgroupware.domain.Chatroom">
    SELECT
      chatroom_id,
      room_type,
      dm_key,
      chatroom_name,
      chatroom_status,
      last_message_at,
      create_date
    FROM chatroom
    WHERE dm_key = #{dmKey}
    LIMIT 1
  </select>
	
	<!-- DM 방 생성 -->
	<insert id="upsertDmChatroom"
        parameterType="com.example.broadcastgroupware.domain.Chatroom"
        useGeneratedKeys="true" keyProperty="chatroomId">
	  INSERT INTO chatroom
	    (room_type, dm_key, chatroom_name, chatroom_status, last_message_at, create_date)
	  VALUES
	    (#{roomType}, #{dmKey}, #{chatroomName}, #{chatroomStatus}, #{lastMessageAt}, NOW())
	  ON DUPLICATE KEY UPDATE
	    chatroom_id = LAST_INSERT_ID(chatroom_id),  <!-- 기존 row의 PK를 getGeneratedKeys로 돌려받게 함 -->
	    chatroom_status = VALUES(chatroom_status)   <!-- 옵션: 상태 갱신 -->
	</insert>
	
	<!-- (옵션) 드라이버/환경에 따라 필요할 수 있음 -->
	<select id="selectLastInsertId" resultType="int">
	  SELECT LAST_INSERT_ID()
	</select>
	
	<!-- 이미 있으면 무시 -->
	<insert id="insertChatroomUserIgnore">
	  INSERT IGNORE INTO chatroom_user (chatroom_id, user_id, create_date)
	  VALUES (#{chatroomId}, #{userId}, NOW())
	</insert>
	
	<!-- 메시지 저장 후 호출 (선택) -->
	<update id="updateChatroomLastActivity" parameterType="int">
	  UPDATE chatroom
	  SET last_message_at = NOW()
	  WHERE chatroom_id = #{chatroomId}
	</update>
	
	<!-- 마지막 메시지 내용 + 시간 동시 갱신 (last_message 컬럼이 있을 때 권장) -->
	<update id="updateChatroomLastMessage" parameterType="map">
	  UPDATE chatroom
	  SET last_message = #{lastMessage},
	      last_message_at = NOW()
	  WHERE chatroom_id = #{chatroomId}
	</update>
	
</mapper>





















