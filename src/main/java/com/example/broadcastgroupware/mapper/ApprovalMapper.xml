<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.broadcastgroupware.mapper.ApprovalMapper">
	
    <!-- 공통(일반) 문서 INSERT -->
    <!-- 
		useGeneratedKeys="true": DB에서 AUTO_INCREMENT로 생성된 PK 값을 가져오도록 설정
		keyProperty="approvalDocumentId": 생성된 PK를 ApprovalDocument 객체의 approvalDocumentId 필드에 자동 세팅
		=> insert 실행 후 doc.getApprovalDocumentId() 호출 시 DB에서 생성된 PK 값 확인 가능
	-->
    <insert id="insertApprovalDocument"
            parameterType="com.example.broadcastgroupware.domain.ApprovalDocument"
            useGeneratedKeys="true" keyProperty="approvalDocumentId">
        INSERT INTO approval_document (
            user_id,approval_document_title, approval_document_content,
            approval_document_status, create_date, update_date
        ) VALUES (
            #{userId}, #{approvalDocumentTitle}, #{approvalDocumentContent},            
            #{approvalDocumentStatus}, NOW(), NOW()
        )
    </insert>  
	
	<!-- 문서 상태 UPDATE -->
	<update id="updateDocumentStatus">
	    UPDATE approval_document
	    SET approval_document_status = #{status},
	        update_date = NOW()
	    WHERE approval_document_id = #{approvalDocumentId}
	</update>
	
	<!-- 팀 ID 들로 소속 사용자 ID 조회 -->
	<select id="selectUserIdsByTeamIds" resultType="int">
	    SELECT DISTINCT u.user_id
	    FROM `user` u
	    JOIN (
	        SELECT dh.user_id, dh.team_id
	        FROM deployment_history dh
	        JOIN (
	            SELECT user_id, MAX(create_date) AS latest_date
	            FROM deployment_history
	            GROUP BY user_id
	        ) latest
	            ON latest.user_id = dh.user_id
	            AND latest.latest_date = dh.create_date
	    ) dh ON dh.user_id = u.user_id
	    WHERE dh.team_id IN
	    <foreach collection="teamIds" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    AND u.user_resign_date IS NULL  <!-- 퇴사자 제외 -->
	</select>


    <!-- 휴가 문서 폼 INSERT -->
    <insert id="insertVacationForm"
            parameterType="com.example.broadcastgroupware.domain.VacationForm"
            useGeneratedKeys="true" keyProperty="vacationFormId">
        INSERT INTO vacation_form (
            approval_document_id, vacation_form_type, vacation_form_half_type,
            vacation_form_start_date, vacation_form_end_date, create_date, update_date    
        ) VALUES (
            #{approvalDocumentId}, #{vacationFormType}, #{vacationFormHalfType},
            #{vacationFormStartDate}, #{vacationFormEndDate}, NOW(), NOW()
        )
    </insert>

    <!-- 방송 문서 폼 INSERT -->
    <insert id="insertBroadcastForm"
            parameterType="com.example.broadcastgroupware.domain.BroadcastForm"
            useGeneratedKeys="true" keyProperty="broadcastFormId">
        INSERT INTO broadcast_form (
            approval_document_id, broadcast_form_name, broadcast_form_capacity,
            broadcast_form_start_date, broadcast_form_end_date,
            broadcast_form_start_time, broadcast_form_end_time,
            create_date, update_date
        ) VALUES (
            #{approvalDocumentId}, #{broadcastFormName}, #{broadcastFormCapacity},
            #{broadcastFormStartDate}, #{broadcastFormEndDate},
            #{broadcastFormStartTime}, #{broadcastFormEndTime},
            NOW(), NOW()
        )
    </insert>
    
    <!-- 방송 요일 INSERT -->
    <insert id="insertBroadcastWeekday"
	        parameterType="com.example.broadcastgroupware.domain.BroadcastWeekday"
	        useGeneratedKeys="true" keyProperty="broadcastWeekdayId">
	    INSERT INTO broadcast_weekday (
	        broadcast_form_id,
	        broadcast_sunday, broadcast_monday, broadcast_tuesday,
	        broadcast_wednesday, broadcast_thursday, broadcast_friday, broadcast_saturday,
	        create_date
	    )
	    VALUES (
	        #{broadcastFormId},
	        #{broadcastSunday}, #{broadcastMonday}, #{broadcastTuesday},
	        #{broadcastWednesday}, #{broadcastThursday}, #{broadcastFriday}, #{broadcastSaturday},
	        NOW()
	    )
	</insert>


	<!-- 결재선 INSERT -->
	<insert id="insertApprovalLines">
	    INSERT INTO approval_line (
	        approval_document_id, user_id, approval_line_sequence,
	        approval_line_status, approval_line_comment, create_date
	    )
	    VALUES
	    <foreach collection="lines" item="l" separator=",">
	        (#{l.approvalDocumentId}, #{l.userId}, #{l.approvalLineSequence},
	         #{l.approvalLineStatus}, #{l.approvalLineComment}, NOW())
	    </foreach>
	</insert>
	
	<!-- 참조선 INSERT -->
	<insert id="insertReferenceLines">
	    INSERT INTO reference_line (
	        approval_document_id, user_id, create_date
	    )
	    VALUES
	    <foreach collection="refs" item="r" separator=",">
	        (#{r.approvalDocumentId}, #{r.userId}, NOW())
	    </foreach>
	</insert>

</mapper>