<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.broadcastgroupware.mapper.VacationMapper">
	<!--현재 근무하고있는 직원들의 userId-->
	<select id="selectJoinUser" resultType="int">
		SELECT user_id userId FROM user WHERE user_resign_date is null
	</select>
	
	<!--전년도에 일한 개월수 만큼 연차 추가-->
	<update id="updateVacation">
		update vacation set vacation_annual_total = (vacation_annual_total+
			(SELECT case when year(user_join_date) = YEAR(NOW())-1 then 13-MONTH(user_join_date) 
			ELSE 12 end vac FROM user WHERE user_id=#{userId}))
		WHERE user_id = #{userId}
	</update>
	
	<!--휴가결재 승인되면 휴가테이블에 사용한 휴가일 수 반영-->
	<update id="updateUseVacation">
		UPDATE vacation SET vacation_annual_use=vacation_annual_use+(SELECT vacation_history_day FROM vacation_history WHERE
			approval_line_id=(SELECT vh.approval_line_id FROM vacation_history vh INNER JOIN approval_line al
			ON vh.approval_line_id = al.approval_line_id WHERE vh.create_date = (SELECT MAX(create_date) FROM vacation_history)))
		WHERE user_id=(SELECT ad.user_id FROM vacation_history vh INNER JOIN approval_line al ON al.approval_line_id = vh.approval_line_id
							INNER JOIN approval_document ad ON al.approval_document_id = ad.approval_document_id
							INNER JOIN vacation_form vf ON vf.approval_document_id = ad.approval_document_id
						WHERE vh.create_date=(SELECT MAX(vh.create_date) FROM vacation_history vh 
													INNER JOIN approval_line al ON al.approval_line_id = vh.approval_line_id
													INNER JOIN approval_document ad ON al.approval_document_id = ad.approval_document_id))
	</update>
	
	<!-- 홈 요약(총/사용/잔여/결재중) : vacation은 즉시값, 결재중은 승인대기 문서 기준 -->
	<select id="selectVacationHomeSummary" parameterType="map" resultType="map">
	  SELECT
	    #{year} AS year,
	
	    <!-- 총/사용/잔여: vacation 테이블의 누적 값을 그대로 사용 -->
	    COALESCE(v.vacation_annual_total, 0)                           AS total,
	    COALESCE(v.vacation_annual_use,   0)                           AS used,
	    COALESCE(v.vacation_annual_total, 0) - COALESCE(v.vacation_annual_use, 0)
	                                                                   AS remaining,
	
	    <!-- 결재중(대기) 개수: 휴가 폼 + 결재선에서 상태가 대기(IN PROGRESS)인 건수 -->
	    (
	      SELECT COUNT(*)
	      FROM approval_line al
	      JOIN approval_document ad  ON ad.approval_document_id = al.approval_document_id
	      JOIN vacation_form    vf   ON vf.approval_document_id = ad.approval_document_id
	      WHERE ad.user_id = v.user_id
	        AND al.approval_line_status IN ('대기')
	        AND YEAR(ad.create_date) = #{year}     
	    ) AS pendingCount
	
	  FROM vacation v
	  WHERE v.user_id = #{userId}
	</select>
	
	
	<!-- 휴가 이력 INSERT -->
    <insert id="insertVacationHistory" parameterType="com.example.broadcastgroupware.domain.VacationHistory">
        INSERT INTO vacation_history 
        	(approval_line_id, vacation_history_day, create_date)
        VALUES 
        	(#{approvalLineId}, #{vacationHistoryDay}, NOW())
    </insert>

    <!-- 휴가 사용일수 누적 -->
    <update id="addUsedVacationDaysByDoc">
        UPDATE vacation v
        JOIN approval_document ad 
        	ON ad.user_id = v.user_id
        SET v.vacation_annual_use = v.vacation_annual_use + #{dayCount}
        WHERE ad.approval_document_id = #{approvalDocumentId}
    </update>
</mapper>