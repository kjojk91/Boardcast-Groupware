<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.example.broadcastgroupware.mapper.ApprovalQueryMapper">
	
	<!-- 공통 ResultMap -->
    <resultMap id="ApprovalDocDtoMap" type="com.example.broadcastgroupware.dto.ApprovalDocumentDto">
	    <id     column="approvalDocumentId"      property="approvalDocumentId"/>
	    <result column="userId"                  property="userId"/>
	    <result column="approvalDocumentTitle"   property="approvalDocumentTitle"/>
	    <result column="approvalDocumentContent" property="approvalDocumentContent"/>
	    <result column="approvalDocumentStatus"  property="approvalDocumentStatus"/>
	    <result column="createDate"              property="createDate"/>
	    <result column="updateDate"              property="updateDate"/>
	    <result column="documentType"            property="documentType"/>
	    <result column="fullName"                property="fullName"/>
	</resultMap>
    
    <!-- 공통 SELECT 컬럼 -->
	<sql id="approvalDocumentColumns">
	    ad.approval_document_id       AS approvalDocumentId,
        ad.user_id                    AS userId,
        ad.approval_document_title    AS approvalDocumentTitle,
        ad.approval_document_content  AS approvalDocumentContent,
        ad.approval_document_status   AS approvalDocumentStatus,
        ad.create_date                AS createDate,
        ad.update_date                AS updateDate,
        CASE
            WHEN bf.broadcast_form_id IS NOT NULL THEN 'BROADCAST'
            WHEN vf.vacation_form_id IS NOT NULL THEN 'VACATION'
            ELSE 'COMMON'
        END AS documentType
	</sql>
	
	<!-- 공통 FROM + JOIN -->
	<sql id="approvalDocumentFromJoins">
	    LEFT JOIN broadcast_form bf
	        ON ad.approval_document_id = bf.approval_document_id
	    LEFT JOIN vacation_form vf
	        ON ad.approval_document_id = vf.approval_document_id
	</sql>
	
	
	<!-- ======== 내 문서함 조회 (목록 조회) ======== -->

	<!-- 진행 중 문서 -->
    <select id="selectInProgressDocuments" parameterType="int"
	    	resultMap="ApprovalDocDtoMap">
	    SELECT <include refid="approvalDocumentColumns" />
	    FROM approval_document ad
	    <include refid="approvalDocumentFromJoins"/>
	    WHERE ad.user_id = #{userId}
	        AND ad.approval_document_status = '진행 중'
	    ORDER BY ad.create_date DESC
	</select>


    <!-- 결재 종료 문서 (승인 + 반려) -->
    <select id="selectCompletedDocuments" parameterType="int" 
    		resultMap="ApprovalDocDtoMap">
	    SELECT <include refid="approvalDocumentColumns" />
	    FROM approval_document ad
	    <include refid="approvalDocumentFromJoins"/>
	    WHERE ad.user_id = #{userId}
	    	AND ad.approval_document_status IN ('승인', '반려')
	    ORDER BY ad.update_date DESC
    </select>

    <!-- 임시저장 문서 -->
    <select id="selectDraftDocuments" parameterType="int" 
    		resultMap="ApprovalDocDtoMap">
	    SELECT <include refid="approvalDocumentColumns" />
	    FROM approval_document ad
		<include refid="approvalDocumentFromJoins"/>
	    WHERE ad.user_id = #{userId}
	    	AND ad.approval_document_status = '임시저장'
	    ORDER BY ad.create_date DESC
    </select>
    
    
    <!-- ======== 내 문서함 조회 (문서 상세 조회) ======== -->
	    
	<!-- 문서 + 기안자 정보 -->
	<select id="selectDocumentDetail" parameterType="int" resultType="map">
	    SELECT 
	        ad.approval_document_id     AS approvalDocumentId,
	        ad.approval_document_title  AS approvalDocumentTitle,
	        ad.approval_document_content AS approvalDocumentContent,
	        ad.approval_document_status AS approvalDocumentStatus,
	        ad.create_date              AS createDate,
	        ad.update_date              AS updateDate,
	
	        u.user_id                   AS userId,
	        u.full_name                 AS fullName,
	        u.user_rank                 AS userRank,
	
	        dept.department_name        AS departmentName,
	        t.team_name                 AS teamName,
	
	        dh.deployment_history_id    AS deploymentHistoryId,
	        dh.team_id                 AS teamId,
	        dh.create_date              AS deploymentHistoryCreateDate
	    FROM approval_document ad
	    JOIN `user` u ON ad.user_id = u.user_id
	    LEFT JOIN (
	        SELECT dh1.*
	        FROM deployment_history dh1
	        INNER JOIN (
	            SELECT user_id, MAX(create_date) AS max_date
	            FROM deployment_history
	            GROUP BY user_id
	        ) latest 
	        	ON dh1.user_id = latest.user_id 
	        		AND dh1.create_date = latest.max_date
	    ) dh 
	    	ON u.user_id = dh.user_id
	    LEFT JOIN team t 
	    	ON dh.team_id = t.team_id
	    LEFT JOIN department dept 
	    	ON t.department_id = dept.department_id
	    WHERE ad.approval_document_id = #{approvalDocumentId}
	</select>
	
	<!-- 방송 폼 상세 (+ 요일) -->
	<select id="selectBroadcastFormDetail" parameterType="int" resultType="map">
	    SELECT 
	        bf.broadcast_form_id         AS broadcastFormId,
	        bf.broadcast_form_name       AS broadcastFormName,
	        bf.broadcast_form_capacity   AS broadcastFormCapacity,
	        bf.broadcast_form_start_date AS broadcastFormStartDate,
	        bf.broadcast_form_end_date   AS broadcastFormEndDate,
	        bf.broadcast_form_start_time AS broadcastFormStartTime,
	        bf.broadcast_form_end_time   AS broadcastFormEndTime,
	
	        bw.broadcast_sunday         AS broadcastSunday,
	        bw.broadcast_monday         AS broadcastMonday,
	        bw.broadcast_tuesday        AS broadcastTuesday,
	        bw.broadcast_wednesday      AS broadcastWednesday,
	        bw.broadcast_thursday       AS broadcastThursday,
	        bw.broadcast_friday         AS broadcastFriday,
	        bw.broadcast_saturday       AS broadcastSaturday
	    FROM broadcast_form bf
	    LEFT JOIN broadcast_weekday bw 
	    	ON bf.broadcast_form_id = bw.broadcast_form_id
	    WHERE bf.approval_document_id = #{approvalDocumentId}
	</select>
	
	<!-- 휴가 폼 상세 -->
	<select id="selectVacationFormDetail" parameterType="int" resultType="map">
	    SELECT 
	        vf.vacation_form_id         AS vacationFormId,
	        vf.vacation_form_type       AS vacationFormType,
	        vf.vacation_form_half_type  AS vacationFormHalfType,
	        vf.vacation_form_start_date AS vacationFormStartDate,
	        vf.vacation_form_end_date   AS vacationFormEndDate
	    FROM vacation_form vf
	    WHERE vf.approval_document_id = #{approvalDocumentId}
	</select>
	
	
	<!-- 결재선 상세 -->
	<select id="selectApprovalLinesByDocumentId" parameterType="int" resultType="map">
	    SELECT 
	        al.approval_line_id         AS approvalLineId,
	        al.approval_document_id     AS approvalDocumentId,
	        al.user_id                  AS userId,
	        al.approval_line_sequence   AS approvalLineSequence,
	        al.approval_line_status     AS approvalLineStatus,
	        al.approval_line_comment    AS approvalLineComment,
	        al.update_date              AS approvalLineUpdateDate,
	        u.full_name                 AS fullName,
	        u.user_rank                 AS userRank,
	        sig.signatureUrl            AS signatureUrl
	    FROM approval_line al
	    JOIN `user` u 
	        ON al.user_id = u.user_id
	    <!--  서명 이미지 (최신 1건) --> 
	    LEFT JOIN (
	        SELECT ui.user_id,
	               CONCAT(ui.user_images_path, '/', ui.user_images_name, '.', ui.user_images_ext) AS signatureUrl
	        FROM user_images ui
	        JOIN (
	            SELECT user_id, MAX(update_date) AS max_ud
	            FROM user_images
	            WHERE user_images_type = '서명'
	            GROUP BY user_id
	        ) latest
	        	ON latest.user_id = ui.user_id
	        	AND latest.max_ud  = ui.update_date
	    	WHERE ui.user_images_type = '서명'
	    ) sig
	      ON sig.user_id = al.user_id
	    WHERE al.approval_document_id = #{approvalDocumentId}
	    ORDER BY al.approval_line_sequence ASC
	</select>
	
	<!-- 참조선 상세 -->
	<select id="selectReferenceLinesByDocumentId" parameterType="int" resultType="map">
	    SELECT
	        rl.reference_line_id        AS referenceLineId,
	        rl.approval_document_id     AS approvalDocumentId,
	        rl.user_id                  AS userId,
	        u.full_name                 AS fullName,
	        u.user_rank                 AS userRank,
	        t.team_id                   AS teamId,
	        t.team_name                 AS teamName,
	        d.department_name           AS departmentName
	    FROM reference_line rl
	    JOIN `user` u ON rl.user_id = u.user_id
	    LEFT JOIN (
	        SELECT dh1.user_id, dh1.team_id
	        FROM deployment_history dh1
	        INNER JOIN (
	            SELECT user_id, MAX(create_date) AS max_date
	            FROM deployment_history
	            GROUP BY user_id
	        ) latest ON dh1.user_id = latest.user_id 
	        	AND dh1.create_date = latest.max_date
	    ) dh 
	    	ON u.user_id = dh.user_id
	    LEFT JOIN team t 
	    	ON t.team_id = dh.team_id
	    LEFT JOIN department d 
	    	ON t.department_id = d.department_id
	    WHERE rl.approval_document_id = #{approvalDocumentId}
	</select>
	
	<!-- 팀별 현재 인원 수 -->
	<select id="selectTeamMemberCountsByIds" resultType="map">
	    SELECT
	        t.team_id           AS teamId,
	        COUNT(*)            AS memberCount
	    FROM (
	        SELECT dh1.user_id, dh1.team_id
	        FROM deployment_history dh1
	        INNER JOIN (
	            SELECT user_id, MAX(create_date) AS max_date
	            FROM deployment_history
	            GROUP BY user_id
	        ) latest
	                ON latest.user_id = dh1.user_id
	               AND latest.max_date = dh1.create_date
	    ) dh
	    JOIN `user` u
	        ON u.user_id = dh.user_id
	       AND u.user_resign_date IS NULL
	    JOIN team t
	        ON t.team_id = dh.team_id
	    WHERE t.team_id IN
	    <foreach collection="teamIds" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    GROUP BY t.team_id
	</select>
	
	
	<!-- ======== 문서 수정 및 삭제 ======== -->
	
	<!-- 첫 결재자 상태 조회 -->
	<select id="selectFirstApproverStatus" parameterType="int" resultType="string">
	    SELECT approval_line_status AS approvalLineStatus
	    FROM approval_line
	    WHERE approval_document_id = #{approvalDocumentId}
	    ORDER BY approval_line_sequence ASC
	    LIMIT 1
	</select>
	
	<!-- 문서의 기안자 ID -->
	<select id="selectDrafterIdByDocumentId" parameterType="int" resultType="int">
	    SELECT user_id AS userId
	    FROM approval_document
	    WHERE approval_document_id = #{approvalDocumentId}
	</select>
	
	
	<!-- ======== 결재 (승인/반려) ======== -->
	
	<!-- 현재 '대기' 차수 -->
	<select id="selectCurrentPendingSequence" parameterType="int" resultType="int">
	    SELECT MIN(approval_line_sequence)
	    FROM approval_line
	    WHERE approval_document_id = #{approvalDocumentId}
	    	AND approval_line_status = '대기'
	</select>
	
	<!-- 해당 문서에서 사용자의 결재선 (차수/상태) -->
	<select id="selectUserApprovalLine" parameterType="map" resultType="map">
	    SELECT
	    	approval_line_id        AS approvalLineId,  
	    	approval_line_sequence  AS approvalLineSequence,
	        approval_line_status    AS approvalLineStatus
	    FROM approval_line
	    WHERE approval_document_id = #{approvalDocumentId}
	    	AND user_id = #{userId}
	    LIMIT 1
	</select>
	
	<!-- 다음 활성화될 차수 (status IS NULL 중 가장 작은 차수) -->
	<select id="selectNextSequenceToActivate" parameterType="int" resultType="int">
	    SELECT MIN(approval_line_sequence)
	    FROM approval_line
	    WHERE approval_document_id = #{approvalDocumentId}
	    	AND approval_line_status IS NULL
	</select>
	
	<!-- 결재자 최신 서명 파일의 전체 경로 -->
	<select id="selectLatestSignatureByUser" parameterType="int" resultType="string">
	    SELECT CONCAT(user_images_path, '/', user_images_name, '.', user_images_ext) AS signatureUrl
	    FROM user_images
	    WHERE user_id = #{userId}
	    	AND user_images_type = '서명'
	    ORDER BY update_date DESC
	    LIMIT 1
	</select>
		
	
	<!-- ======== 받은 문서 조회 (로그인한 사용자가 결재자인 문서) ======== -->

    <!-- 결재 대기: 사용자가 현재 '대기'인 문서 -->
    <select id="selectMyPendingApprovals" parameterType="int" resultMap="ApprovalDocDtoMap">
        SELECT <include refid="approvalDocumentColumns" />, u.full_name AS fullName
        FROM approval_document ad
        <include refid="approvalDocumentFromJoins"/>
        JOIN approval_line al ON al.approval_document_id = ad.approval_document_id
        JOIN `user` u ON ad.user_id = u.user_id
        WHERE al.user_id = #{userId}
        	AND al.approval_line_status = '대기'
          	AND ad.approval_document_status = '진행 중'
        ORDER BY ad.create_date DESC
    </select>

    <!-- 결재 진행 중: 사용자는 '승인' + 문서는 아직 진행 중 -->
    <select id="selectMyInProgressApprovals" parameterType="int" resultMap="ApprovalDocDtoMap">
        SELECT <include refid="approvalDocumentColumns" />, u.full_name AS fullName
        FROM approval_document ad
        <include refid="approvalDocumentFromJoins"/>
        JOIN approval_line al ON al.approval_document_id = ad.approval_document_id
        JOIN `user` u ON ad.user_id = u.user_id
        WHERE al.user_id = #{userId}
        	AND al.approval_line_status = '승인'
          	AND ad.approval_document_status = '진행 중'
        ORDER BY ad.update_date DESC
    </select>

    <!-- 결재 종료: 최종 승인/반려 문서 -->
	<select id="selectMyCompletedApprovals" parameterType="map" resultMap="ApprovalDocDtoMap">
	    SELECT <include refid="approvalDocumentColumns" />, u.full_name AS fullName
	    FROM approval_document ad
	    <include refid="approvalDocumentFromJoins"/>
	    JOIN `user` u ON ad.user_id = u.user_id
	    WHERE ad.approval_document_status IN ('승인','반려')
	    	AND EXISTS (
	        	SELECT 1
	          	FROM approval_line al
	          	WHERE al.approval_document_id = ad.approval_document_id
	            	AND al.user_id = #{userId}
	      	)
	      <choose>
	          <when test="status != null and status == 'APPROVED'">
	              AND ad.approval_document_status = '승인'
	          </when>
	          <when test="status != null and status == 'REJECTED'">
	              AND ad.approval_document_status = '반려'
	          </when>
	          <otherwise>
	              <!-- ALL -->
	          </otherwise>
	      </choose>
	    ORDER BY ad.update_date DESC
	</select>

    <!-- 참조 문서 -->
    <select id="selectReferencedDocuments" parameterType="int" 
    		resultMap="ApprovalDocDtoMap">
	    SELECT <include refid="approvalDocumentColumns" />,
	    	u.full_name AS fullName
	    FROM approval_document ad
	    <include refid="approvalDocumentFromJoins"/>
	    INNER JOIN reference_line rl
	        ON ad.approval_document_id = rl.approval_document_id
	    INNER JOIN `user` u 
	    	ON ad.user_id = u.user_id
	    WHERE rl.user_id = #{userId}
	    ORDER BY ad.create_date DESC
    </select>
	
</mapper>